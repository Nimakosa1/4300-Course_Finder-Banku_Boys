{% extends "base.html" %} {% block title %}Search Results - CourseFinder{%
endblock %} {% block extra_head %}
<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  #word-cloud-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 100;
    background-color: #111111;
  }

  .hidden {
    display: none !important;
  }
</style>
{% endblock %} {% block content %}
<!-- Word Cloud Loading Animation -->
{% if query %}
<div id="word-cloud-container">
  <!-- WordCloud will be rendered here -->
</div>
{% endif %}

<!-- Search bar at the top -->
<div class="bg-white shadow-sm p-4 sticky top-0 z-10">
  <div class="max-w-7xl mx-auto flex items-center justify-between">
    <a href="{{ url_for('index') }}" class="text-2xl font-bold">
      CourseFinder
    </a>
    <form
      action="{{ url_for('search_page') }}"
      method="GET"
      class="flex w-full max-w-xl"
    >
      <input
        type="text"
        name="q"
        placeholder="Search for classes"
        class="flex-grow rounded-l-md border border-gray-300 p-2"
        value="{{ query }}"
      />
      <button
        type="submit"
        class="bg-black hover:bg-gray-700 text-white px-4 py-2 rounded-r-md"
      >
        Search
      </button>
    </form>
  </div>
</div>

<!-- Main content area -->
<div
  id="main-content"
  class="max-w-7xl mx-auto p-4 grid grid-cols-1 md:grid-cols-12 gap-6 mt-6 {% if query %}hidden{% endif %}"
>
  <!-- Left column - Class List -->
  <div class="md:col-span-3">
    <h2 class="text-xl font-semibold mb-4">
      Search Results (<span id="results-count">0</span>)
    </h2>

    <div
      id="error-message"
      class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden"
    ></div>

    <div
      id="search-results"
      class="space-y-6 max-h-[calc(100vh-180px)] overflow-y-auto pr-2 pb-4"
    >
      <p id="loading-message" class="text-gray-500">Loading courses...</p>
      <p id="no-results-message" class="text-gray-500 hidden">
        {% if query %} No results found for "{{ query }}" {% else %} Enter a
        search query {% endif %}
      </p>
    </div>
  </div>

  <!-- Middle column - Course Details & Reviews -->
  <div class="md:col-span-6">
    <div
      id="course-details"
      class="max-h-[calc(100vh-180px)] overflow-y-auto pr-2 pb-4"
    >
      <div
        class="flex items-center justify-center h-64"
        id="select-course-message"
      >
        <p class="text-gray-500">Select a course to view details</p>
      </div>
    </div>
  </div>

  <!-- Right column - Filters -->
  <div class="md:col-span-3">
    <div
      class="border rounded-lg shadow-sm max-h-[calc(100vh-180px)] overflow-y-auto"
    >
      <div class="p-4 border-b">
        <h2 class="text-lg font-semibold">Filters</h2>
      </div>
      <div class="p-4">
        <div class="space-y-6">
          <!-- Semester Filters -->
          <div>
            <h3 class="text-sm font-semibold mb-2 text-gray-700">Semester</h3>
            <div class="space-y-2">
              {% for semester in ['Fall', 'Spring', 'Summer', 'Winter'] %}
              <div class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  id="{{ semester.lower() }}"
                  class="semester-filter"
                  value="{{ semester }}"
                />
                <label
                  for="{{ semester.lower() }}"
                  class="text-sm font-medium leading-none"
                >
                  {{ semester }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Class Level Filters -->
          <div>
            <h3 class="text-sm font-semibold mb-2 text-gray-700">
              Class Level
            </h3>
            <div class="space-y-2">
              {% for level in ['1000', '2000', '3000', '4000', '5000+'] %}
              <div class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  id="level{{ level }}"
                  class="level-filter"
                  value="{{ level }}"
                />
                <label
                  for="level{{ level }}"
                  class="text-sm font-medium leading-none"
                >
                  {{ level }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Difficulty Filters -->
          <div>
            <h3 class="text-sm font-semibold mb-2 text-gray-700">Difficulty</h3>
            <div class="space-y-2">
              {% for difficulty in ['Easy', 'Medium', 'Hard'] %}
              <div class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  id="difficulty-{{ difficulty.lower() }}"
                  class="difficulty-filter"
                  value="{{ difficulty }}"
                />
                <label
                  for="difficulty-{{ difficulty.lower() }}"
                  class="text-sm font-medium leading-none"
                >
                  {{ difficulty }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Workload Filters -->
          <div>
            <h3 class="text-sm font-semibold mb-2 text-gray-700">Workload</h3>
            <div class="space-y-2">
              {% for workload in ['Light', 'Moderate', 'Heavy'] %}
              <div class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  id="workload-{{ workload.lower() }}"
                  class="workload-filter"
                  value="{{ workload }}"
                />
                <label
                  for="workload-{{ workload.lower() }}"
                  class="text-sm font-medium leading-none"
                >
                  {{ workload }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Clear Filters Button -->
          <button
            id="clear-filters"
            class="w-full py-2 px-4 border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-50"
          >
            Clear All Filters
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Load Word Cloud Script -->

<script src="{{ url_for('static', filename='js/word_cloud.js') }}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const query = "{{ query }}";
    const searchResults = document.getElementById("search-results");
    const loadingMessage = document.getElementById("loading-message");
    const noResultsMessage = document.getElementById("no-results-message");
    const resultsCount = document.getElementById("results-count");
    const errorMessage = document.getElementById("error-message");
    const courseDetails = document.getElementById("course-details");
    const selectCourseMessage = document.getElementById(
      "select-course-message"
    );
    const mainContent = document.getElementById("main-content");
    const wordCloudContainer = document.getElementById("word-cloud-container");

    let allCourses = [];
    let selectedCourse = null;
    let wordCloud = null;

    // Initialize word cloud if query exists
    if (query && wordCloudContainer) {
      wordCloud = new WordCloud(wordCloudContainer);
      wordCloud.setOnComplete(() => {
        // Hide word cloud and show main content
        wordCloudContainer.classList.add("hidden");
        mainContent.classList.remove("hidden");
      });
    } else {
      // If no query, hide word cloud and show content
      if (wordCloudContainer) {
        wordCloudContainer.classList.add("hidden");
      }
      mainContent.classList.remove("hidden");
    }

    // Fetch search results
    if (query) {
      fetchSearchResults(query);
    } else {
      loadingMessage.classList.add("hidden");
      noResultsMessage.classList.remove("hidden");
    }

    // Event listeners for filters
    document
      .querySelectorAll(
        ".semester-filter, .level-filter, .difficulty-filter, .workload-filter"
      )
      .forEach((filter) => {
        filter.addEventListener("change", applyFilters);
      });

    document
      .getElementById("clear-filters")
      .addEventListener("click", clearFilters);

    // Functions
    function fetchSearchResults(query) {
      // Show loading state
      loadingMessage.classList.remove("hidden");
      noResultsMessage.classList.add("hidden");
      errorMessage.classList.add("hidden");

      // Clear previous search results
      searchResults.innerHTML = "";
      searchResults.appendChild(loadingMessage);

      // Build API URL
      const apiUrl = `/api/search?q=${encodeURIComponent(query)}`;

      fetch(apiUrl)
        .then((response) => {
          if (!response.ok) {
            return response.text().then((text) => {
              throw new Error(`API returned ${response.status}: ${text}`);
            });
          }
          return response.json();
        })
        .then((data) => {
          loadingMessage.classList.add("hidden");
          allCourses = data;

          if (!data || data.length === 0) {
            noResultsMessage.classList.remove("hidden");
            resultsCount.textContent = "0";
          } else {
            resultsCount.textContent = data.length;
            renderSearchResults(data);

            // Select the first course by default
            if (data.length > 0) {
              selectCourse(data[0]);
            }

            // If we have keywords data, update the word cloud
            if (data.keywords && wordCloud) {
              wordCloud.words = data.keywords;
              wordCloud.positionWords();
            }
          }
        })
        .catch((error) => {
          console.error("Error fetching search results:", error);
          loadingMessage.classList.add("hidden");
          errorMessage.textContent = `Failed to fetch search results: ${error.message}`;
          errorMessage.classList.remove("hidden");

          // Hide word cloud on error
          if (wordCloudContainer) {
            wordCloudContainer.classList.add("hidden");
          }
          mainContent.classList.remove("hidden");
        });
    }

    // Rest of your code remains the same
    function renderSearchResults(courses) {
      searchResults.innerHTML = "";

      courses.forEach((course) => {
        const classItem = document.createElement("div");

        // Determine selected state
        const isSelected =
          selectedCourse && selectedCourse.course_code === course.course_code;
        const borderClass = isSelected
          ? "border-blue-500 shadow-md"
          : "hover:shadow-md hover:border-blue-300";

        // Format semesters
        const semesterHtml = (course.term_offered || course.semester || [])
          .map((sem) => {
            let colorClass = "bg-gray-100 text-gray-800";
            if (sem.trim() === "Fall")
              colorClass = "bg-amber-100 text-amber-800";
            else if (sem.trim() === "Spring")
              colorClass = "bg-green-100 text-green-800";
            else if (sem.trim() === "Summer")
              colorClass = "bg-blue-100 text-blue-800";
            else if (sem.trim() === "Winter")
              colorClass = "bg-indigo-100 text-indigo-800";

            return `<span class="text-xs px-2 py-0.5 rounded ${colorClass}">${sem.trim()}</span>`;
          })
          .join("");

        // Format distributions
        const distHtml =
          (course.distribution || course.distributions || []).length > 0
            ? `<div class="mt-2 flex flex-wrap gap-1">
            ${(course.distribution || course.distributions || [])
              .map(
                (dist) =>
                  `<span class="text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-800">${dist}</span>`
              )
              .join("")}
          </div>`
            : "";

        classItem.innerHTML = `
          <div class="border rounded-lg transition-shadow cursor-pointer ${borderClass}" data-id="${
          course.course_code
        }">
            <div class="p-4">
              <div class="flex items-center space-x-2 mb-1">
                <span class="text-sm font-medium text-gray-500">
                  ${course.course_code}
                </span>
                <div class="flex flex-wrap gap-1">
                  ${semesterHtml}
                </div>
              </div>
              <h3 class="font-semibold">${
                course["course title"] || course.title || "No Title"
              }</h3>
              <p class="text-sm text-gray-600 mt-1 line-clamp-2">
                ${course.description || ""}
              </p>
              ${distHtml}
            </div>
          </div>
        `;

        classItem.querySelector("[data-id]").addEventListener("click", () => {
          selectCourse(course);
        });

        searchResults.appendChild(classItem);
      });
    }

    function selectCourse(course) {
      selectedCourse = course;

      // Update selected state in results list
      document.querySelectorAll("[data-id]").forEach((element) => {
        if (element.getAttribute("data-id") === course.course_code) {
          element.classList.add("border-blue-500", "shadow-md");
          element.classList.remove("hover:border-blue-300");
        } else {
          element.classList.remove("border-blue-500", "shadow-md");
          element.classList.add("hover:border-blue-300");
        }
      });

      // Hide the select course message
      if (selectCourseMessage) {
        selectCourseMessage.style.display = "none";
      }

      // Render course details
      renderCourseDetails(course);
    }

    // The rest of the functions remain the same
    function renderCourseDetails(course) {
      // Prepare course data
      const courseData = {
        course_code: course.course_code || "",
        title: course["course title"] || course.title || "No Title",
        description: course.description || "No description available",
        avgDifficulty: course.avgDifficulty || 0,
        avgWorkload: course.avgWorkload || 0,
        term_offered: course.term_offered || course.semester || [],
        distributions: course.distributions || course.distribution || [],
        reviews: course.reviews || [],
      };

      // Create the details HTML
      let detailsHtml = `
        <div class="border rounded-lg shadow-sm mb-6">
          <div class="p-6">
            <div class="mb-2 flex items-center">
              <span class="text-lg font-medium text-gray-500 mr-2">
                ${courseData.course_code}
              </span>
            </div>
            <h2 class="text-2xl font-bold mb-4">${courseData.title}</h2>
            <p class="text-gray-700 mb-4">${courseData.description}</p>

            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="flex flex-col">
                <span class="text-sm text-gray-500">Difficulty</span>
                <span class="font-semibold">
                  ${
                    courseData.avgDifficulty > 0
                      ? `${courseData.avgDifficulty.toFixed(1)}/5`
                      : "N/A"
                  }
                </span>
              </div>
              <div class="flex flex-col">
                <span class="text-sm text-gray-500">Workload</span>
                <span class="font-semibold">
                  ${
                    courseData.avgWorkload > 0
                      ? `${courseData.avgWorkload.toFixed(1)}/5`
                      : "N/A"
                  }
                </span>
              </div>
            </div>

            <div class="mb-4">
              <span class="font-semibold">Terms Offered: </span>
              <span>${
                courseData.term_offered.length > 0
                  ? courseData.term_offered.join(", ")
                  : "Not specified"
              }</span>
            </div>

            <div class="mb-4">
              <span class="font-semibold">Distributions: </span>
              <span>${
                courseData.distributions.length > 0
                  ? courseData.distributions.join(", ")
                  : "None"
              }</span>
            </div>
          </div>
        </div>

        <h2 class="text-xl font-semibold my-4">Reviews</h2>
        <div class="space-y-6">
      `;

      // Add reviews (max 2)
      if (courseData.reviews && courseData.reviews.length > 0) {
        // Show only first two reviews
        courseData.reviews.slice(0, 2).forEach((review) => {
          detailsHtml += `<div class="border rounded-lg shadow-sm mb-4"><div class="p-4">`;

          if (review.professor && review.professor !== "N/A") {
            detailsHtml += `
              <div class="mb-2">
                <div class="text-sm text-gray-600 font-medium">
                  Professor: ${review.professor}
                </div>
              </div>
            `;
          }

          if (review.major && review.major !== "N/A") {
            detailsHtml += `
              <div class="mb-2">
                <div class="text-sm text-gray-600">
                  Major: ${review.major}
                </div>
              </div>
            `;
          }

          if (review.grade && review.grade !== "N/A") {
            detailsHtml += `
              <div class="mb-2">
                <div class="text-sm text-gray-600">
                  Grade: ${review.grade}
                </div>
              </div>
            `;
          }

          detailsHtml += `<div class="flex flex-wrap gap-4 mb-3">`;

          if (review.overall && review.overall !== "-") {
            detailsHtml += `
              <div class="flex items-center">
                <span class="text-sm font-medium mr-2">Overall:</span>
                ${renderStarsClient(parseInt(review.overall))}
              </div>
            `;
          }

          if (review.difficulty && review.difficulty !== "-") {
            detailsHtml += `
              <div class="flex items-center">
                <span class="text-sm font-medium mr-2">Difficulty:</span>
                ${renderStarsClient(parseInt(review.difficulty))}
              </div>
            `;
          }

          if (review.workload && review.workload !== "-") {
            detailsHtml += `
              <div class="flex items-center">
                <span class="text-sm font-medium mr-2">Workload:</span>
                ${renderStarsClient(parseInt(review.workload))}
              </div>
            `;
          }

          detailsHtml += `</div>`;

          if (review.comment) {
            detailsHtml += `<p class="text-gray-700 mb-3">${review.comment}</p>`;
          }

          detailsHtml += `</div></div>`;
        });
      } else {
        detailsHtml += `<p class="text-gray-500">No reviews available for this course.</p>`;
      }

      detailsHtml += `</div>`;

      // Add "See more" button
      const courseDataForLink = {
        id: courseData.course_code,
        classCode: courseData.course_code,
        title: courseData.title,
        description: courseData.description,
        semester: courseData.term_offered,
        distribution: courseData.distributions,
        reviews: courseData.reviews,
        avgDifficulty: courseData.avgDifficulty,
        avgWorkload: courseData.avgWorkload,
        avgOverall: course.avgOverall || 0,
      };

      detailsHtml += `
        <div class="mt-6">
          <a 
            href="/class/${courseData.course_code.replace(
              /\s+/g,
              "-"
            )}?data=${encodeURIComponent(JSON.stringify(courseDataForLink))}"
            class="inline-block w-full px-4 py-2 bg-black hover:bg-gray-700 text-white text-center font-medium rounded-md"
          >
            See more about class
          </a>
        </div>
      `;

      // Update the course details container
      courseDetails.innerHTML = detailsHtml;
    }

    function renderStarsClient(rating, maxRating = 5) {
      let stars = "";
      const numRating = parseInt(rating) || 0;

      for (let i = 0; i < maxRating; i++) {
        const starColor = i < numRating ? "text-yellow-400" : "text-gray-300";
        stars += `
          <svg class="w-5 h-5 ${starColor}" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
          </svg>
        `;
      }

      return stars;
    }

    function applyFilters() {
      const filters = {
        semester: Array.from(
          document.querySelectorAll(".semester-filter:checked")
        ).map((el) => el.value),
        classLevel: Array.from(
          document.querySelectorAll(".level-filter:checked")
        ).map((el) => el.value),
        difficulty: Array.from(
          document.querySelectorAll(".difficulty-filter:checked")
        ).map((el) => el.value),
        workload: Array.from(
          document.querySelectorAll(".workload-filter:checked")
        ).map((el) => el.value),
      };

      // Filter courses
      const filteredCourses = filterCourses(allCourses, filters);

      // Update results count
      resultsCount.textContent = filteredCourses.length;

      // Render filtered results
      renderSearchResults(filteredCourses);

      // If filtered results is empty, show no results message
      if (filteredCourses.length === 0) {
        noResultsMessage.classList.remove("hidden");
      } else {
        noResultsMessage.classList.add("hidden");

        // Check if selected course is still in filtered results
        const isSelectedCourseInResults =
          selectedCourse &&
          filteredCourses.some(
            (course) => course.course_code === selectedCourse.course_code
          );

        if (!isSelectedCourseInResults && filteredCourses.length > 0) {
          // Select the first course in filtered results
          selectCourse(filteredCourses[0]);
        }
      }
    }

    function clearFilters() {
      // Uncheck all filter checkboxes
      document
        .querySelectorAll(
          ".semester-filter, .level-filter, .difficulty-filter, .workload-filter"
        )
        .forEach((checkbox) => {
          checkbox.checked = false;
        });

      // Reapply filters (which will now show all results)
      applyFilters();
    }

    function filterCourses(courses, filters) {
      // If no filters are applied, return all courses
      if (
        !filters.semester.length &&
        !filters.classLevel.length &&
        !filters.difficulty.length &&
        !filters.workload.length
      ) {
        return courses;
      }

      return courses.filter((course) => {
        // Check semester filter
        if (filters.semester.length > 0) {
          const courseTerms = course.term_offered || course.semester || [];
          const hasMatchingSemester = courseTerms.some((sem) =>
            filters.semester.includes(sem.trim())
          );

          if (!hasMatchingSemester) return false;
        }

        // Check class level filter
        if (filters.classLevel.length > 0) {
          // Extract level from course code (e.g., "COMP 101" -> "1000")
          const match = (course.course_code || "").match(/\d{3}/);
          if (match) {
            const courseLevel = match[0][0] + "000";

            // Special case for 5000+
            const levelToCheck =
              parseInt(match[0][0]) >= 5 ? "5000+" : courseLevel;

            if (!filters.classLevel.includes(levelToCheck)) {
              return false;
            }
          } else {
            return false;
          }
        }

        // Check difficulty filter
        if (filters.difficulty.length > 0) {
          const avgDifficulty = course.avgDifficulty || 0;

          const matchesDifficulty =
            (filters.difficulty.includes("Easy") &&
              avgDifficulty > 0 &&
              avgDifficulty < 2.5) ||
            (filters.difficulty.includes("Medium") &&
              avgDifficulty >= 2.5 &&
              avgDifficulty < 3.5) ||
            (filters.difficulty.includes("Hard") && avgDifficulty >= 3.5);

          if (!matchesDifficulty) return false;
        }

        // Check workload filter
        if (filters.workload.length > 0) {
          const avgWorkload = course.avgWorkload || 0;

          const matchesWorkload =
            (filters.workload.includes("Light") &&
              avgWorkload > 0 &&
              avgWorkload < 2.5) ||
            (filters.workload.includes("Moderate") &&
              avgWorkload >= 2.5 &&
              avgWorkload < 3.5) ||
            (filters.workload.includes("Heavy") && avgWorkload >= 3.5);

          if (!matchesWorkload) return false;
        }

        // If passed all filters, include in results
        return true;
      });
    }
  });
</script>
{% endblock %}
